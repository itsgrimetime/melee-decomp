# Function Extractor Architecture

## Overview

The Function Extractor module is designed to extract comprehensive information about functions from the Super Smash Bros. Melee decompilation project. It combines data from multiple sources to provide a complete picture of each function's status, assembly code, and decompilation context.

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                     FunctionExtractor                           │
│                     (Main Orchestrator)                         │
└───────────────────────────┬─────────────────────────────────────┘
                            │
            ┌───────────────┼───────────────┐
            │               │               │
            ▼               ▼               ▼
    ┌───────────┐   ┌──────────┐   ┌──────────────┐
    │  Parser   │   │ Symbols  │   │   Splits     │
    │ configure │   │ symbols  │   │  splits.txt  │
    │   .py     │   │   .txt   │   │              │
    └───────────┘   └──────────┘   └──────────────┘
            │               │               │
            ▼               ▼               ▼
    ┌───────────┐   ┌──────────┐   ┌──────────────┐
    │  Report   │   │   Asm    │   │   Context    │
    │ report    │   │  build/  │   │  decompctx   │
    │  .json    │   │  asm/    │   │   generator  │
    └───────────┘   └──────────┘   └──────────────┘
            │               │               │
            └───────────────┼───────────────┘
                            ▼
                    ┌──────────────┐
                    │ FunctionInfo │
                    │   (Model)    │
                    └──────────────┘
```

## Components

### 1. Models (`models.py`)

Pydantic models that define the data structures:

- **ObjectStatus**: Status of an object file (Matching/NonMatching/Equivalent)
- **FunctionSymbol**: Function symbol from symbols.txt (name, address, size)
- **FunctionMatch**: Match data from report.json (fuzzy match percentage)
- **FunctionInfo**: Complete function information (combines all data)
- **ExtractionResult**: Result of extracting multiple functions

### 2. Configure Parser (`parser.py`)

Parses `configure.py` to extract:
- Object file paths
- Matching status (Matching, NonMatching, Equivalent)
- Library assignments

**Algorithm**:
1. Read configure.py content
2. Use regex to find `Object(Status, "path/to/file.c")` patterns
3. Track current library context from `MeleeLib("name", ...)` declarations
4. Return list of ObjectStatus instances

### 3. Symbol Parser (`symbols.py`)

Parses `config/GALE01/symbols.txt` to extract:
- Function names
- Memory addresses (hex)
- Function sizes (bytes)
- Section information (.text, .init, etc.)
- Scope (global, local, weak)

**Format**: `function_name = section:0xADDRESS; // type:function size:0xSIZE scope:SCOPE`

### 4. Splits Parser (`splits.py`)

Parses `config/GALE01/splits.txt` to map:
- Functions to source files (by address range)
- Source files to memory ranges
- Sections to address ranges

**Key Feature**: Provides accurate function-to-file mapping based on memory addresses.

**Algorithm**:
1. Parse file headers (`path/to/file.c:`)
2. Parse section ranges (`.section start:0xSTART end:0xEND`)
3. Build mapping of address ranges to files
4. Use binary search to find file for a given address

### 5. Report Parser (`report.py`)

Parses `build/GALE01/report.json` to extract:
- Per-function fuzzy match percentages
- Overall matching statistics

**Note**: report.json is generated by objdiff-cli during the build process. If not present, defaults to 0% for NonMatching and 100% for Matching objects.

**Flexible Parsing**: Handles multiple potential JSON structures since the exact format may vary by objdiff version.

### 6. ASM Extractor (`asm.py`)

Extracts assembly code from `build/GALE01/asm/`:
- Complete ASM file for a source file
- Individual function assembly by name
- List of functions in an ASM file

**Algorithm for Function Extraction**:
1. Find `.global function_name` directive
2. Find `function_name:` label
3. Extract instructions until next function or section
4. Handle special cases (blr, .size directive)

### 7. Context Generator (`context.py`)

Generates decompilation context for decomp.me:
- Recursively expands #include directives
- Tracks include guards to avoid duplicates
- Processes both relative and absolute includes

**Based on**: The melee project's `tools/decompctx.py`

**Features**:
- Header guard detection (`#ifndef`, `#pragma once`)
- Include path resolution (src/, include/, build/GALE01/include/)
- Fallback to web context viewer URL

### 8. Function Extractor (`extractor.py`)

Main orchestrator that combines all components:

**Workflow**:
```python
def extract_function(name):
    1. Get symbol from SymbolParser (address, size, section)
    2. Use SplitsParser to find source file (by address + section)
    3. Get object status from ConfigureParser (Matching/NonMatching)
    4. Get match percentage from ReportParser (if available)
    5. Extract ASM from AsmExtractor (if requested)
    6. Generate context from ContextGenerator (if requested)
    7. Combine into FunctionInfo
```

**Key Methods**:
- `extract_all_functions()`: Extract all functions (19,000+)
- `extract_unmatched_functions()`: Extract only non-matching functions
- `extract_function(name)`: Extract a specific function

## Data Flow

### Extracting a Single Function

```
User Request: extract_function("lbCollision_CheckMove")
    │
    ├─> SymbolParser: Get address (0x80006420) and size (144 bytes)
    │
    ├─> SplitsParser: Find file by address → "melee/lb/lbcollision.c"
    │
    ├─> ConfigureParser: Get status → "NonMatching"
    │
    ├─> ReportParser: Get fuzzy match → 87.5%
    │
    ├─> AsmExtractor: Get PowerPC assembly code
    │
    ├─> ContextGenerator: Generate #includes and type definitions
    │
    └─> Return FunctionInfo with all data combined
```

### Extracting All Unmatched Functions

```
User Request: extract_unmatched_functions()
    │
    ├─> ConfigureParser: Get all NonMatching objects (318 files)
    │
    ├─> SymbolParser: Get all function symbols (19,807 functions)
    │
    ├─> SplitsParser: Map each function to source file
    │
    ├─> ReportParser: Get match percentages (if available)
    │
    ├─> Filter: Keep only functions with match < 100%
    │
    └─> Return ExtractionResult with unmatched functions
```

## Performance Considerations

### Fast Operations
- Parsing configure.py: ~1ms (regex-based)
- Parsing symbols.txt: ~100ms (19,807 functions)
- Parsing splits.txt: ~50ms (960 files)
- Finding file for function: ~1ms (using splits mapping)

### Slow Operations
- Parsing all ASM files: ~5-10s (960 files)
- Generating context: ~500ms-2s per file (recursive includes)
- Extracting all functions: ~30-60s (19,807 functions)

### Optimization Strategies
1. **Lazy Loading**: Parse files only when needed
2. **Caching**: Cache parsed results (splits, symbols)
3. **Selective Extraction**: Only extract ASM/context when requested
4. **Batch Processing**: Process multiple functions together

## Dependencies

### Required
- **Python 3.10+**: For type hints and match statements
- **Pydantic 2.x**: For data validation and models

### Optional
- **objdiff-cli**: For generating report.json
- **ninja**: For building the project

## File Structure

```
src/extractor/
├── __init__.py          # Public API exports
├── models.py            # Pydantic data models
├── parser.py            # Configure.py parser
├── symbols.py           # Symbols.txt parser
├── splits.py            # Splits.txt parser
├── report.py            # Report.json parser
├── asm.py               # Assembly extractor
├── context.py           # Context generator
├── extractor.py         # Main orchestrator
├── example.py           # Usage examples
├── README.md            # User documentation
└── ARCHITECTURE.md      # This file
```

## Error Handling

### Graceful Degradation
- If report.json is missing: Use object status for match percentage
- If ASM file is missing: Return None for asm field
- If context generation fails: Return None for context field
- If function not found: Return None instead of error

### File Not Found Handling
- configure.py: Raise FileNotFoundError (required)
- symbols.txt: Raise FileNotFoundError (required)
- splits.txt: Raise FileNotFoundError (required)
- report.json: Return empty dict (optional)
- ASM files: Return None (optional)

## Testing Strategy

### Unit Tests
- Each parser independently tested
- Mock file contents for testing
- Verify data model validation

### Integration Tests
- Test complete extraction workflow
- Verify data consistency across components
- Test with real melee project files

### Performance Tests
- Benchmark parsing operations
- Monitor memory usage for large extractions
- Test caching effectiveness

## Future Enhancements

### Potential Improvements
1. **Parallel Processing**: Use multiprocessing for ASM extraction
2. **Database Backend**: Cache results in SQLite for faster queries
3. **Incremental Updates**: Only re-parse changed files
4. **Web API**: Expose extractor as REST API
5. **CLI Tool**: Command-line interface for quick queries
6. **Progress Tracking**: Show progress for long-running operations
7. **Diff Support**: Compare function changes over time
8. **Export Formats**: Export to JSON, CSV, etc.

### Extensibility Points
- Custom parsers for other decompilation projects
- Plugin system for additional data sources
- Configurable extraction strategies
- Custom output formatters
